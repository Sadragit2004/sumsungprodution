{% extends "db_template.html" %}
{% load static %}
{% load humanize %}


{% block content %}
<main class="p-6 flex-1 overflow-y-auto">
    <div class="bg-white rounded-2xl min-h-80 h-auto shadow-custom p-4">
        <!-- هدر صفحه -->
        <div class="px-2 md:px-3 pt-3 pb-5 mb-3 text-zinc-700 text-sm md:text-base flex items-center gap-x-2 border-b border-zinc-200">
            <svg class="fill-primary-500" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256">
                <path d="M128,16a88.1,88.1,0,0,0-88,88c0,75.3,80,132.17,83.41,134.55a8,8,0,0,0,9.18,0C136,236.17,216,179.3,216,104A88.1,88.1,0,0,0,128,16Zm0,56a32,32,0,1,1-32,32A32,32,0,0,1,128,72Z"></path>
            </svg>
            جزئیات سفارش #{{ order.orderCode }}
        </div>

        <!-- لیست محصولات سفارش -->
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3 xl:gap-4 mb-6">
            {% for item in order.details.all %}
            <div class="bg-white border border-zinc-200 rounded-2xl p-2 md:p-3 text-sm hover:shadow-custom transition-shadow">
                <!-- تصویر محصول -->
                <a href="{{ item.product.get_absolute_url }}" class="text-zinc-800">
                    {% if item.product.image %}
                        <img class="rounded-xl mb-3 w-full h-32 object-cover" src="{{ item.product.image.url }}" alt="{{ item.product.title }}">
                    {% else %}
                        <img class="rounded-xl mb-3 w-full h-32 object-cover" src="{% static 'assets/image/products/default.webp' %}" alt="تصویر پیش‌فرض">
                    {% endif %}
                </a>

                <!-- عنوان و برند محصول -->
                <p class="text-zinc-400 text-xs">
                    {{ item.brand.title|default:"بدون برند" }}
                </p>
                <a href="{{ item.product.get_absolute_url }}" class="text-zinc-800 text-xs md:text-sm h-8 lg:h-10 line-clamp-2 mt-2 block">
                    {{ item.product.title }}
                </a>

                <!-- ویژگی‌های انتخابی -->
                {% if item.selectedOptions %}
                <div class="mt-2 text-xs text-zinc-500">
                    <span class="font-medium">ویژگی‌ها:</span> {{ item.selectedOptions }}
                </div>
                {% endif %}

                <!-- امتیاز و رنگ‌ها -->
                <div class="flex items-center justify-between mt-4">
                    <div class="flex gap-1.5">
                        <!-- این قسمت می‌تواند برای نمایش رنگ‌های محصول باشد -->
                        <div class="size-4 bg-zinc-800 rounded-full"></div>
                        <div class="size-4 bg-zinc-500 rounded-full"></div>
                        <div class="size-4 bg-zinc-300 rounded-full"></div>
                    </div>
                    <div class="flex items-start gap-x-1 text-xs text-zinc-500">
                        <span>
                            <span>({{ item.product.comments.count }})</span>
                            <span>{{ item.product.avg_rating }}</span>
                        </span>
                        <svg class="fill-primary-500" xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#f9bc00" viewBox="0 0 256 256">
                            <path d="M234.5,114.38l-45.1,39.36,13.51,58.6a16,16,0,0,1-23.84,17.34l-51.11-31-51,31a16,16,0,0,1-23.84-17.34L66.61,153.8,21.5,114.38a16,16,0,0,1,9.11-28.06l59.46-5.15,23.21-55.36a15.95,15.95,0,0,1,29.44,0h0L166,81.17l59.44,5.15a16,16,0,0,1,9.11,28.06Z"></path>
                        </svg>
                    </div>
                </div>

                <!-- قیمت و تعداد -->
                <div class="flex items-center justify-between border-t border-dashed border-zinc-300 mt-4 pt-2">
                    <div class="text-zinc-500 text-xs">
                        {{ item.qty }} عدد
                    </div>
                    <div class="text-zinc-800 flex items-center gap-x-1 justify-end font-yekanBakhBold text-lg">
                        {{ item.getTotalPrice|intcomma }}
                        <img class="size-4" src="{% static 'assets/image/icons/toman.png' %}" alt="تومان">
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-8 text-zinc-500">
                هیچ محصولی در این سفارش وجود ندارد.
            </div>
            {% endfor %}
        </div>

        <!-- اطلاعات پرداخت -->
        <div id="capture" class="w-full bg-white">
            <div class="px-2 sm:px-6 py-3 rounded-xl border border-zinc-300 my-5 mx-auto max-w-lg">
                <div class="flex gap-x-1 justify-center items-center text-zinc-700">
                    <svg class="fill-zinc-500" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256">
                        <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm-4,48a12,12,0,1,1-12,12A12,12,0,0,1,124,72Zm12,112a16,16,0,0,1-16-16V128a8,8,0,0,1,0-16,16,16,0,0,1,16,16v40a8,8,0,0,1,0,16Z"></path>
                    </svg>
                    اطلاعات پرداخت
                </div>

                <!-- قیمت کل کالاها -->
                <div class="flex gap-x-1 justify-between items-center text-zinc-600 mt-5 bg-gray-100 rounded-lg px-2 py-3 text-sm">
                    <div>قیمت کالاها ({{ order.details.count }})</div>
                    <div class="flex gap-x-1">
                        <div>{{ order.getTotalPrice|intcomma }}</div>
                        <div>تومان</div>
                    </div>
                </div>

                <!-- تخفیف -->
                {% if order.discount %}
                <div class="flex gap-x-1 justify-between items-center text-zinc-600 mt-3 bg-gray-100 rounded-lg px-2 py-3 text-sm">
                    <div>تخفیف</div>
                    <div class="flex gap-x-1 text-green-600">
                        <div>{{ order.discount }}%</div>
                        <div>({{ order.getTotalPrice|add:"-"|add:order.getFinalPrice|intcomma }} تومان)</div>
                    </div>
                </div>
                {% endif %}

                <!-- تاریخ ثبت -->
                <div class="flex gap-x-1 justify-between items-center text-zinc-600 mt-3 bg-gray-100 rounded-lg px-2 py-3 text-sm">
                    <div>تاریخ ثبت</div>
                    <div class="flex gap-x-1">
                        <div>{{ order.registerDate|date:"Y/m/d" }}</div>
                    </div>
                </div>

                <!-- شماره پیگیری -->
                <div class="flex gap-x-1 justify-between items-center text-zinc-600 mt-3 bg-gray-100 rounded-lg px-2 py-3 text-sm">
                    <div>شماره پیگیری</div>
                    <div class="flex gap-x-1">
                        <div>#{{ order.orderCode }}</div>
                    </div>
                </div>

                <!-- وضعیت سفارش -->
                <div class="flex gap-x-1 justify-between items-center text-zinc-600 mt-3 bg-gray-100 rounded-lg px-2 py-3 text-sm">
                    <div>وضعیت سفارش</div>
                    <div class="flex gap-x-1">
                        <div>{{ order.get_status_display }}</div>
                    </div>
                </div>

                <!-- جمع سبد خرید -->
                <div class="flex gap-x-1 justify-between items-center text-zinc-800 mt-3 bg-gray-100 rounded-lg px-2 py-3 text-sm font-bold">
                    <div>مبلغ نهایی</div>
                    <div class="flex gap-x-1">
                        <div>{{ order.getFinalPrice|intcomma }}</div>
                        <div>تومان</div>
                    </div>
                </div>

                <!-- آدرس -->
                {% if order.addressDetail %}
                <div class="flex gap-x-1 justify-between items-center text-zinc-800 mt-3 bg-gray-100 rounded-lg px-2 py-3 text-sm">
                    <div>آدرس</div>
                    <div class="text-left max-w-[200px]">{{ order.addressDetail }}</div>
                </div>
                {% endif %}

                <!-- توضیحات -->
                {% if order.description %}
                <div class="flex gap-x-1 justify-between items-center text-zinc-800 mt-3 bg-gray-100 rounded-lg px-2 py-3 text-sm">
                    <div>توضیحات</div>
                    <div class="text-left max-w-[200px]">{{ order.description }}</div>
                </div>
                {% endif %}

                <!-- دکمه چاپ -->
                <a href="#" onclick="downloadImage()" class="block text-center w-full px-2 py-3 mt-5 text-sm bg-gradient-to-bl from-primary-500 to-primary-700 hover:opacity-80 transition text-gray-100 rounded-lg">
                    چاپ فاکتور
                </a>
            </div>
        </div>
    </div>
</main>
{% endblock content %}

{% block extra_js %}
<script>

function downloadImage() {
    // استفاده از html2canvas برای گرفتن عکس از بخش مشخص شده
    html2canvas(document.getElementById('capture')).then(function(canvas) {
        // ایجاد لینک دانلود
        var link = document.createElement('a');
        link.download = 'فاکتور-سفارش-{{ order.orderCode }}.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}

</script>

{% endblock %}